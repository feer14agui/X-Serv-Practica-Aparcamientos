from django.shortcuts import render
from django.http import HttpResponse
from .models import Aparcamiento, Usuario, Fecha, Comentario
from django.views.decorators.csrf import csrf_exempt
from django.core.exceptions import ObjectDoesNotExist
import datetime
from django.shortcuts import redirect
from django.template.loader import get_template
from django.template import Context
#from urlib.parse import unquote_plus

# Create your views here.
@csrf_exempt
#Lista de aparcamientos con la url
def lista_aparcamientos():
	#obtengo todos los aparcamientos
	aparcamientos = Aparcamiento.objects.all()

	#Creo la lista de aparcamientos
	Lista_Aparcamientos = "<ol>"
	for i in aparcamientos:
		Lista_Aparcamientos += i.Nombre
		Lista_Aparcamientos += '<li><a href="'  + i.Enlace + '">' + i.Enlace + '</a><br>'
		Lista_Aparcamientos += "<br>"

	Lista_Aparcamientos += "</ol>"
	return(Lista_Aparcamientos)

#Lista de aparcamientos sin la url
def lista_aparcamientos2():
	
	#obtengo todos los aparcamientos
	aparcamientos = Aparcamiento.objects.all()
	aparcamientos_ordenados = aparcamientos.order_by("-Num_Comentarios")
	#Creo la lista de aparcamientos
	Lista_Aparcamientos2 = ''
	for i in aparcamientos_ordenados:
		Lista_Aparcamientos2 += '<li><a href="'  + i.Enlace + '">' + i.Nombre + '</a><br>'
		Lista_Aparcamientos2 += 'Dirección: ' + i.Clase_vial + ' ' + i.Nombre_via + '<br>'
		Lista_Aparcamientos2 += '<li><a href=http://localhost:1234/aparcamientos/'+ str(i.ident) + '>' + 'Más información</a><br>'
		Lista_Aparcamientos2 += "<br>"
		
	return(Lista_Aparcamientos2)

#menu para loguearse
def log ():
	salida = '<form action="" method="POST">'
	salida += 'Nombre de usuario<br><input type="text" name="Usuario"><br>'
	salida += 'Password<br><input type="password" name="Password">'
	salida += '<br><br><input type="submit" value="Entrar"><br><br>'
	salida += '</form>'
    
	return (salida)

def Lista_Usuarios():
	
	usuarios = Usuario.objects.all()
	for i in usuarios:
		Lista_Usuarios = 'Listado de páginas personales: <br>'
		Lista_Usuarios = i.Nombre + ' ' + '<li><a href=http://localhost:1234/'+ str(i.Nombre) + '>' + 'Más información</a><br>'

	Respuesta = Lista_Usuarios
	return(Respuesta)

def form_titulo():

	respuesta = '<form action="" method="POST">'
	respuesta += 'Titulo de página <br><input type="text" name="Titulo"><br>'
	respuesta += '<input type="submit" value="Entrar"><br><br>'
	respuesta += '</form>'

	return (respuesta)

def todos():

	respuesta = '<li><a href="/aparcamientos/"' + '>' + 'Todos</a><br>'

	return(respuesta)

def red_about():

	respuesta = '<li><a href="/about/"' + '>' + 'Ayuda</a><br>'

	return(respuesta)

def logearse ():
	
	usuario = request.POST['Usuario']
	contraseña = request.POST['Password']
	return (True)
	
def aparcamientos(request):

	#Hago el formulario para firmar por distritos
	Formulario = "Filtrar por distritos:"
	Formulario += '<form action="" method="POST">'
	Formulario += 'Distrito: <input type="text" name="Distrito">'
	Formulario += "<br>"
	Formulario += '<input type="submit" value="Filtrar">'
	Formulario += "<br>"
	Formulario += "<br>"

	Lista = lista_aparcamientos ()

	#Si me llegan un POST, porque he enviado un distrito a filtrar
	if request.method == "POST":
		Distrito_filtrado = request.POST['Distrito']

		if Distrito_filtrado == '':
			return HttpResponse("No ha introducido ningún distrito, vuelva a intentarlo" + "<br>" + Formulario + Lista)
		else:
			Lista_Filtrada = ""
			for i in aparcamientos:
				if Distrito_filtrado == i.Distrito:
					Lista_Filtrada += i.Nombre
					Lista_Filtrada += '<li><a href="'  + i.Enlace + '">' + i.Enlace + '</a>'
					Lista_Filtrada += "<br>"
					Lista_Filtrada += "<br>"

			#Si no hay ningun distrito con ese nombre
			if Lista_Filtrada == '':
				return HttpResponse("No hay ningún aparcamiento disponible en este distrito, vuelva a intentarlo" +"<br>" + Formulario)
			else:
				return HttpResponse(Formulario + Lista_Filtrada)

	return HttpResponse(Formulario + Lista)
	
@csrf_exempt
def aparcamientos_id(request, recurso):
	
	try:
		aparcamiento = Aparcamiento.objects.get(ident=recurso)

		Nombre = aparcamiento.Nombre
		Nombre_via = aparcamiento.Nombre_via
		Via = aparcamiento.Clase_vial
		Numero = aparcamiento.Numero
		Localidad = aparcamiento.Numero
		Provincia = aparcamiento.Provincia
		Cod_Postal = aparcamiento.Cod_Postal
		Barrio = aparcamiento.Barrio
		Distrito = aparcamiento.Distrito
		Coord_X = aparcamiento.Coord_X
		Coord_Y = aparcamiento.Coord_Y
		Latitud = aparcamiento.Latitud
		Longitud = aparcamiento.Longitud
		Enlace = aparcamiento.Enlace
		Descripcion = aparcamiento.Descripcion
		Accesibilidad = aparcamiento.Accesibilidad
		Datos_Contacto = aparcamiento.datos_contacto
	
		if Accesibilidad == 1:
			Acces = "Accesible"
		else:
			Acces = "No Accesible"

		Respuesta = "<p>Esta es la página con la información del aparcamiento: " +'<li><a href="'  + Enlace + '">' + Nombre + '</a>' + "</br></p>"
		Respuesta += "Descripción: " + Descripcion + "<br>"
		Respuesta += "<br>"
		Respuesta += "Barrio: " + Barrio + "<br>"
		Respuesta += "<br>"
		Respuesta += "Distrito: " + Distrito + "<br>"
		Respuesta += "<br>"
		Respuesta += "Latitud: " + str(Latitud) + "<br>"
		Respuesta += "<br>"
		Respuesta += "Longitud: " + str(Longitud) + "<br>"
		Respuesta += "<br>"
		Respuesta += "Accesibilidad: " + Acces + "<br>"
		Respuesta += "<br>"
		Respuesta += "Datos Contacto: " + Datos_Contacto + "<br>"

		Formulario = "<br> Añade tu comentario: "
		Formulario += '<form action="" method="POST">'
		Formulario += 'Comentario: <input type="text" name="Comentario">'
		Formulario += ""
		Formulario += '<input type="submit" value="Comentar">'
		Formulario += "<br>"
		Formulario += "<br>"

		Respuesta += Formulario
		
		if request.method == "POST":
			comentario = request.POST['Comentario']
			aparcamiento = Aparcamiento.objects.get(ident=recurso)
			aparcamiento.Num_Comentarios = aparcamiento.Num_Comentarios + 1
			
			aparcamiento.save()
			p = Comentario(Aparcamiento=aparcamiento, Texto=comentario)
			p.save()

		Lista_Comentarios = Comentario.objects.all()
		Respuesta += 'Comentarios: <br>'
		for i in Lista_Comentarios:
			if aparcamiento == i.Aparcamiento:
				Respuesta += i.Texto
				Respuesta += '<br><br>'
		
		return HttpResponse(Respuesta)
	
	except ObjectDoesNotExist:
		
		return HttpResponse("Este identificador no corresponde con ningún aparcamiento")

@csrf_exempt
def usuario(request, peticion):

	Titulo_Pagina = form_titulo()

	today = datetime.datetime.today()
	#Cuando me llega un POST al seleccionar un aparcamiento
	if request.method == "POST":
		key = request.body.decode('utf-8').split('=')[0]
		if key == 'Titulo':
			Titulo = request.POST[key]
			usuario = Usuario.objects.get(Nombre=peticion)
			usuario.Titulo_pagina = Titulo
			usuario.save()
		elif key == 'Seleccion':
			nombre_aparcamiento = request.POST[key]
			lista_usuario = Fecha.objects.all()
			try:
				aparcamiento = Aparcamiento.objects.get(Nombre=nombre_aparcamiento)
				Encontrado = False
				for i in lista_usuario:
					#Si el aparcamiento ya lo tengo en la lista de seleccionados no lo añado
					if nombre_aparcamiento == i.Aparcamiento.Nombre:
						Encontrado = True

				if Encontrado == False:
					p = Fecha(Aparcamiento=aparcamiento, Usuario=usuario, Fecha=today)
					p.save()
			except ObjectDoesNotExist:
				return('') 

	try:
		usuario = Usuario.objects.get(Nombre=peticion)
	#Si el usuario no tiene nombre de pagina
		if usuario.Titulo_pagina == ' ':
			Respuesta = 'Página principal de ' + usuario.Nombre + ': Página de ' + usuario.Nombre + '<br><br>'
		else:
			Respuesta = 'Página principal de ' + usuario.Nombre + ': ' + usuario.Titulo_pagina + '<br><br>'
	except ObjectDoesNotExist:
		Respuesta = 'No existe el usuario' + '<br>'

	Formulario = ''

	#Hago la lista de aparcamientos seleccionados por el usuario
	Respuesta += Titulo_Pagina + '<br> Lista de aparcamientos seleccionados por el Usuario ' + usuario.Nombre + '<br>'
	usuario = Usuario.objects.get(Nombre=peticion)
	lista_usuario = Fecha.objects.all()

	for i in lista_usuario:
		Formulario += '<br>'
		Formulario += '<li><a href="'  + i.Aparcamiento.Enlace + '">' + i.Aparcamiento.Nombre + '</a><br>'
		Formulario += 'Dirección: ' + i.Aparcamiento.Clase_vial + ' ' + i.Aparcamiento.Nombre_via + '<br>'
		Formulario += 'Fecha: ' + str(i.Fecha) + '<br>'
		Formulario += '<li><a href=http://localhost:1234/aparcamientos/'+ str(i.Aparcamiento.ident) + '>' + 'Más información</a><br>'
	Respuesta += Formulario + '<br><br>'


	#Hago la lista de todos los aparcamientos para poder seleccionarlos
	Respuesta += 'Lista de aparcamientos <br><br>'
	aparcamientos = Aparcamiento.objects.all()
	Lista_Aparcamientos = ''
	Boton = ''
	for i in aparcamientos:
		Respuesta += i.Nombre
		Respuesta += '<li><a href="'  + i.Enlace + '">' + i.Enlace + '</a>'
		Respuesta += "<br>"

		Respuesta += '<form action="" method="POST">'
		Respuesta += '<button type="submit" name="Seleccion" value="' + i.Nombre + '">Seleccion</button><br>'
		Respuesta += "<br>"
		
	return HttpResponse(Respuesta)

@csrf_exempt
def pag_ppal (request):
	
	imagen_principal = '<img src="/static/img/banner.jpg"/>'
	Templates = get_template("coffee_n_cream/index.html")
	c = Context({'banner': imagen_principal})#aqui tengo quemeter las variables que qiero en la plantilla
	renderizado = Templates.render(c)
	return HttpResponse(renderizado)
	#obtengo todos los aparcamientos
	Lista = lista_aparcamientos2()
	Log = log()
	Respuesta = Log + Lista
	Todos = todos()
	About = red_about()
	print(About)
	#Ahora quiero coger las paginas personales
	Usuarios = Lista_Usuarios()
	Respuesta = Log + Lista + Usuarios
	#Hagoel botón para que solo se vean los accesibles
	Respuesta += '<br><form action="" method="POST">'
	Respuesta += '<button type="submit" name="Accesibles" value= "Accesibles">Accesibles</button><br>'
	Respuesta += "<br>"
	
	Lista_Accesibles = ''
	if request.method == "POST":
		key = request.body.decode('utf-8').split('=')[0]
		value = request.body.decode('utf-8').split('=')[1]
		
		if key == 'Accesibles':
			print(value)
			Respuesta = Log + Usuarios + '<br>'
	#Ahora paso a hacer el listado de los aparcamientos accesibles
			aparcamientos_accesibles = Aparcamiento.objects.filter(Accesibilidad=True)
			if value == 'No':
				print('entraa')
				Lista_Accesibles += Lista
				Lista_Accesibles += '<br><form action="" method="POST">'
				Lista_Accesibles += '<button type="submit" name="Accesibles" value= "Accesibles">Accesibles</button><br>'
				Lista_Accesibles += "<br>"
			else:
				Boton = '<br><form action="" method="POST">'
				Boton += '<button type="submit" name="Accesibles" value= "No">noooo</button><br>'
				Boton += "<br>"
			#Lista_Accesibles = ''
				for i in aparcamientos_accesibles:
					Lista_Accesibles += 'Listado de los aparcamientos accesibles: '
					Lista_Accesibles += '<li><a href="'  + i.Enlace + '">' + i.Nombre + '</a><br>'
					Lista_Accesibles += 'Dirección: ' + i.Clase_vial + ' ' + i.Nombre_via + '<br>'
					Lista_Accesibles += '<li><a href=http://localhost:1234/aparcamientos/'+ str(i.ident) + '>' + 'Más información</a><br>'
					Lista_Accesibles += "<br>"

				Lista_Accesibles += Boton

		elif key == 'Usuario':
			user = request.POST['Usuario']
			contraseña = request.POST['Password']
			
			try:
				usuario = ''
				usuario = Usuario.objects.get(Nombre=user)
				if contraseña == usuario.Contraseña:
					redirect(pag_ppal)	
			except ObjectDoesNotExist:
				return HttpResponse ('Este usuario no está registrado')

		elif key == 'Todos':
			redirect(aparcamientos)
			
	Respuesta += Lista_Accesibles
	Respuesta += Todos
	Respuesta += About

	return HttpResponse(Respuesta)

def about(request):
	Respuesta = ("Hola soy about")

	return HttpResponse(Respuesta)




	
